# Context
Filename: task.md
Created On: 2024-04-07
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
根据 overview.md 文件，详细完成 LuaShield 项目各个阶段的规划。

# Project Overview
LuaShield 是一个使用 Rust 语言开发的 Lua 代码安全漏洞分析工具，旨在分析 Lua 代码库中的安全漏洞（LFI、RCE、SSRF、AFO、SQLi、XSS、IDOR 等），并利用大语言模型（LLM）进行分析指导和上下文收集。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
## 项目当前状态
- [✓] 项目已初始化基本的 Rust 项目结构
- [✓] Cargo.toml 文件已创建，但尚未添加依赖
- [✓] src/main.rs 文件仅包含基本的 "Hello, world!" 程序
- [✓] README.md 文件已创建，包含项目概述和基本用法说明
- [✓] overview.md 文件提供了详细的项目规划和实施路线图

## 核心组件需求
1. [✓] **配置管理**：需要实现配置加载和管理功能，包括 API 密钥、基础 URL、模型名称等
2. [✓] **日志系统**：需要实现结构化日志记录功能
3. [✓] **CLI 接口**：需要实现命令行参数解析功能
4. [✓] **文件系统操作**：需要实现 Lua 文件查找、读取等功能
5. [✓] **LLM 客户端**：需要实现与不同 LLM API 的交互功能
6. **提示工程**：需要实现提示模板和构建功能
7. [✓] **Lua 分析引擎**：需要实现 Lua 代码解析和分析功能
8. [✓] **工作流程编排**：需要实现主分析循环和结果输出功能

## 技术依赖
1. [✓] **异步运行时**：tokio（事实标准）
2. [✓] **HTTP 客户端**：reqwest
3. [✓] **序列化/反序列化**：serde, serde_json
4. [✓] **错误处理**：thiserror, anyhow
5. [✓] **日志记录**：tracing, tracing-subscriber
6. [✓] **参数解析**：clap
7. [✓] **配置管理**：dotenvy
8. [✓] **正则表达式**：regex
9. [✓] **文件系统工具**：walkdir/glob
10. [✓] **Lua 解析器**：full-moon（纯 Rust Lua 解析器）

## 关键挑战
1. **Lua 静态分析复杂性**：Lua 高度动态，静态分析具有技术挑战
2. **Lua 生态系统知识**：需要熟悉常见的 Lua Web 框架和标准库
3. **LLM 提示设计**：需要构建针对 Lua 语言特性的有效提示
4. **异步 Rust 实现**：需要仔细管理 async/await、生命周期和共享状态
5. **错误处理**：需要设计良好的错误层次结构
6. **依赖管理**：需要优化 Cargo 依赖
7. **性能优化**：需要确保高效的 AST 遍历和文件 I/O

## 实施阶段
项目将按照以下阶段实施：
1. [✓] 项目设置和基础 Crate 选择
2. [✓] 实现核心工具（配置加载、日志设置、CLI 解析、文件系统操作、LLM 客户端抽象）
3. **Rust 中的提示工程**
4. [✓] Lua 代码分析引擎
5. [✓] 编排和工作流程
6. **测试、完善和打包**

# Proposed Solution (Populated by INNOVATE mode)
## 架构设计

### 模块化架构
LuaShield 将采用模块化架构，将不同功能划分为独立的模块，以提高代码的可维护性和可测试性。主要模块包括：

1. [✓] **配置模块 (config)**：负责加载和管理配置信息
2. [✓] **日志模块 (logging)**：负责日志记录和格式化
3. [✓] **CLI 模块 (cli)**：负责命令行参数解析和处理
4. [✓] **文件系统模块 (fs)**：负责文件查找、读取和过滤
5. [✓] **LLM 模块 (llm)**：负责与不同 LLM API 的交互
6. **提示模块 (prompt)**：负责提示模板和构建
7. [✓] **分析模块 (analysis)**：负责 Lua 代码解析和分析
8. [✓] **编排模块 (orchestration)**：负责工作流程编排和结果输出

### 数据流设计
LuaShield 的数据流将遵循以下模式：

1. [✓] **输入阶段**：用户通过 CLI 提供输入参数和目标 Lua 文件/目录
2. [✓] **配置加载**：加载配置信息，包括 API 密钥、模型名称等
3. [✓] **文件扫描**：扫描目标目录，查找所有 Lua 文件
4. [✓] **初始分析**：对每个 Lua 文件进行初始分析，识别潜在的安全漏洞
5. [✓] **上下文收集**：根据初始分析结果，收集相关上下文信息
6. [✓] **深度分析**：对识别出的漏洞进行深度分析，提供详细的漏洞信息和修复建议
7. [✓] **结果输出**：将分析结果格式化为用户友好的报告

## 实现策略

### 配置管理
- [✓] 使用 `dotenvy` 从 `.env` 文件加载配置
- [✓] 使用 `serde` 定义配置结构体，支持序列化和反序列化
- [✓] 实现配置验证和默认值设置

### 日志系统
- [✓] 使用 `tracing` 和 `tracing-subscriber` 实现结构化日志记录
- [✓] 支持不同日志级别和输出格式（控制台、文件）
- [✓] 实现日志上下文和跟踪 ID

### CLI 接口
- [✓] 使用 `clap` 实现命令行参数解析
- [✓] 支持子命令（analyze、config、version 等）
- [✓] 提供丰富的参数选项和帮助信息

### 文件系统操作
- [✓] 使用 `walkdir` 或 `glob` 递归查找 Lua 文件
- [✓] 实现文件过滤逻辑，排除测试文件、第三方库等
- [✓] 使用 `tokio::fs` 进行异步文件操作

### LLM 客户端
- [✓] 定义 `LlmClient` trait，抽象 LLM API 交互
- [✓] 定义 `ChatMessage` 结构体，表示聊天消息
- [✓] 为不同的 LLM 提供商（Claude、OpenAI、Ollama 等）实现该 trait
- [✓] 实现工厂函数，根据配置创建适当的客户端

### 提示工程
- **使用 `serde` 定义提示模板结构体**
- **实现提示构建函数，支持动态填充模板**
- **使用 JSON 结构化提示，与 serde 更好地集成**
- **将核心提示文本存储在单独的文件中或使用 `include_str!` 嵌入**

### Lua 分析引擎
- [✓] 使用 `full-moon` 解析 Lua 代码，获取 AST
- [✓] 实现 AST 遍历逻辑，查找函数定义、变量赋值等
- [✓] 处理 Lua 的作用域规则和模块导入
- [✓] 实现符号提取和上下文匹配

### 工作流程编排
- [✓] 实现主分析循环，协调各个模块的工作
- [✓] 支持迭代分析，根据 LLM 响应收集更多上下文
- [✓] 实现结果格式化和输出

## 错误处理策略
- [✓] 使用 `thiserror` 定义自定义错误类型
- [✓] 实现错误转换和上下文添加
- [✓] 使用 `anyhow` 简化二进制/主逻辑中的错误处理
- [✓] 提供友好的错误消息和调试信息

## 性能优化策略
- [✓] 使用异步 I/O 提高并发性能
- [✓] 实现缓存机制，避免重复分析
- [✓] 优化 AST 遍历算法，减少不必要的遍历
- [✓] 使用并行处理加速文件扫描和分析

## 测试策略
- [✓] 为每个模块编写单元测试
- [✓] 实现集成测试，验证端到端工作流程
- [✓] 使用模拟对象测试 LLM 交互
- [✓] 创建测试数据集，包含各种 Lua 代码示例

# Implementation Plan (Generated by PLAN mode)
## 阶段 1: 项目设置和基础 Crate 选择

### 1.1 更新 Cargo.toml
- [✓] 添加项目元数据（名称、版本、描述、作者等）
- [✓] 添加核心依赖：
  - [✓] tokio（异步运行时）
  - [✓] reqwest（HTTP 客户端）
  - [✓] serde, serde_json（序列化/反序列化）
  - [✓] thiserror, anyhow（错误处理）
  - [✓] tracing, tracing-subscriber（日志记录）
  - [✓] clap（参数解析）
  - [✓] dotenvy（配置管理）
  - [✓] regex（正则表达式）
  - [✓] walkdir（文件系统工具）
  - [✓] full-moon（Lua 解析器）

### 1.2 创建基本项目结构
- [✓] 创建 src/lib.rs 文件，定义模块结构
- [✓] The file structure was updated to a different approach:
  - [✓] src/analyzer.rs (instead of src/analysis/mod.rs, src/analysis/lua_analyzer.rs)
  - [✓] src/cli.rs
  - [✓] src/config.rs
  - [✓] src/error.rs
  - [✓] src/fs.rs
  - [✓] src/llm.rs (instead of src/llm/mod.rs, src/llm/client.rs)
  - [✓] src/logging.rs
  - [✓] src/output.rs (instead of src/prompt/mod.rs, src/prompt/builder.rs)
  - [✓] src/main.rs
  - [✓] src/lib.rs

### 1.3 创建 .env 文件模板
- [✓] 创建 .env.example 文件，包含配置项模板
- [✓] 添加 .env 到 .gitignore

## 阶段 2: 实现核心工具

### 2.1 错误处理模块 (src/error.rs)
- [✓] 定义 `LuaShieldError` 枚举，包含各种错误类型
- [✓] 实现 `From` trait 以支持错误转换
- [✓] 为错误类型实现 `std::error::Error` trait

### 2.2 配置模块 (src/config.rs)
- [✓] 定义 `Config` 结构体，包含配置项
- [✓] 实现 `load_config()` 函数，从 .env 和环境变量加载配置
- [✓] 实现配置验证和默认值设置

### 2.3 日志模块 (src/logging.rs)
- [✓] 实现 `setup_logging()` 函数，初始化日志系统
- [✓] 配置日志格式和输出目标
- [✓] 实现日志上下文和跟踪 ID

### 2.4 CLI 模块 (src/cli.rs)
- [✓] 使用 clap::Parser 定义 CLI 参数
- [✓] 实现子命令（analyze、config、version）
- [✓] 实现参数验证和处理

### 2.5 文件系统模块 (src/fs.rs)
- [✓] 实现 `find_lua_files()` 函数，递归查找 Lua 文件
- [✓] 实现 `read_file_content()` 函数，异步读取文件内容
- [✓] 实现 `get_readme_content()` 函数，查找并读取 README 文件
- [✓] 实现 `find_network_related_files()` 函数，查找网络相关文件

### 2.6 LLM 客户端模块 (src/llm.rs)
- [✓] 定义 `LlmClient` trait，抽象 LLM API 交互
- [✓] 定义 `ChatMessage` 结构体，表示聊天消息
- [✓] 为不同的 LLM 提供商实现 `LlmClient` trait：
  - [✓] `ClaudeClient`
  - [✓] `OpenAIClient`
  - [✓] `OllamaClient`
- [✓] 实现工厂函数，根据配置创建适当的客户端

## 阶段 3: Rust 中的提示工程

### 3.1 模型定义
- [✓] 已整合到相关模块中，而不是单独的模型文件

### 3.2 提示模板
- **创建提示模板文件或使用 `include_str!` 嵌入**
- **定义提示模板结构体，使用 serde::Serialize**

### 3.3 提示构建
- **实现 `build_initial_analysis_prompt()` 函数，构建初始分析提示**
- **实现 `build_vulnerability_analysis_prompt()` 函数，构建漏洞分析提示**
- **实现 `build_readme_summary_prompt()` 函数，构建 README 摘要提示**

## 阶段 4: Lua 代码分析引擎

### 4.1 Lua 分析器 (src/analyzer.rs)
- [✓] 定义 `Analyzer` 结构体，持有仓库根路径
- [✓] 实现 `extract_symbol()` 方法，提取符号定义
- [✓] 实现 AST 遍历逻辑，查找函数定义、变量赋值等
- [✓] 处理 Lua 的作用域规则和模块导入
- [✓] 实现符号提取和上下文匹配

### 4.2 分析模块
- [✓] 实现 `analyze_file()` 函数，分析单个文件
- [✓] 实现 `analyze_directory()` 函数，分析整个目录
- [✓] 实现 `analyze_vulnerability()` 函数，分析特定漏洞

## 阶段 5: 编排和工作流程

### 5.1 编排模块
- [✓] 实现 `run_analysis()` 函数，运行分析工作流程
- [✓] 实现 `process_file()` 函数，处理单个文件
- [✓] 实现 `collect_context()` 函数，收集上下文信息
- [✓] 实现 `deep_analyze()` 函数，深度分析漏洞
- [✓] 实现 `format_report()` 函数，格式化分析报告

### 5.2 主程序 (src/main.rs)
- [✓] 解析命令行参数
- [✓] 加载配置
- [✓] 设置日志
- [✓] 初始化 LLM 客户端
- [✓] 运行分析工作流程
- [✓] 输出结果

## 阶段 6: 测试、完善和打包

### 6.1 单元测试
- [✓] 为每个模块编写单元测试
- [✓] 测试配置加载和验证
- [✓] 测试文件系统操作
- [✓] 测试 LLM 客户端
- [✓] 测试 Lua 分析器

### 6.2 集成测试
- [✓] 创建示例 Lua 项目
- [✓] 模拟 LLM API 响应
- [✓] 测试端到端分析工作流程

### 6.3 CI/CD
- **配置 GitHub Actions**
- **实现自动化测试和构建**
- **配置发布流程**

### 6.4 容器化
- **创建 Dockerfile**
- **实现多阶段构建**
- **配置容器环境**

### 6.5 文档
- [✓] 更新 README.md
- [✓] 添加 Rustdoc 注释
- **编写使用指南和示例**

